# yamllint disable rule:truthy rule:line-length
---
name: Sync shared assets into Ansible collections

on:
  # Auto-sync when shared assets change
  push:
    branches: ["main"]
    paths:
      - "default/**"
      - "ansible-collection/**"
      - ".github/workflows/sync-ansible-collections.yml"
  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  sync-collections:
    name: Sync shared assets â†’ ${{ matrix.repo }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        repo:
          - ansible-collection-foundational
          - ansible-collection-rhel
          - ansible-collection-supplementary
          - ansible-collection-ocp

    steps:
      # --------------------------------------------------------------------
      # 1) Checkout shared-assets (this repo)
      # --------------------------------------------------------------------
      - name: Checkout shared-assets
        uses: actions/checkout@v6
        with:
          path: shared-assets
          persist-credentials: false

      # --------------------------------------------------------------------
      # 2) Checkout target collection repo with bot token
      # --------------------------------------------------------------------
      - name: Checkout target collection repo
        uses: actions/checkout@v6
        with:
          repository: lightning-it/${{ matrix.repo }}
          path: repo
          token: ${{ secrets.SYNC_BOT_TOKEN }}
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git author in target repo
        working-directory: repo
        run: |
          git config user.name "litreleasebot"
          git config user.email "litreleasebot@users.noreply.github.com"

      # --------------------------------------------------------------------
      # 3) Sync Ansible-collection-specific assets
      #    (.ansible-lint, ansible.cfg, shared pre-commit block, devtools, CI)
      # --------------------------------------------------------------------
      - name: Sync Ansible collection assets
        working-directory: repo
        run: |
          set -e

          SRC_AC="../shared-assets/ansible-collection/base"
          SRC_DEFAULT="../shared-assets/default"

          # ------------------------------------------------------------------
          # Copy all shared top-level files if present
          # ------------------------------------------------------------------
          for f in \
            ".ansible-lint" \
            "ansible.cfg" \
            "renovate.base.json" \
            "AGENT.md" \
            "CONTRIBUTING.md" \
            ".releaserc" \
            ".yamllint" \
            "LICENSE" \
            ".gitignore"
          do
            if [ -f "${SRC_AC}/${f}" ]; then
              echo "Syncing ${f} from shared-assets/ansible-collection..."
              cp -f "${SRC_AC}/${f}" "./${f}"
            fi
          done

          # ------------------------------------------------------------------
          # Copy default assets (org-wide templates)
          # ------------------------------------------------------------------
          for f in \
            "CODE_OF_CONDUCT.md" \
            "SECURITY.md"
          do
            if [ -f "${SRC_DEFAULT}/${f}" ]; then
              echo "Syncing ${f} from shared-assets/default..."
              cp -f "${SRC_DEFAULT}/${f}" "./${f}"
            fi
          done

          # ------------------------------------------------------------------
          # Shared pre-commit block:
          # Replace content between the markers in .pre-commit-config.yaml:
          #   # >>> BEGIN shared-assets pre-commit
          #   ...
          #   # <<< END shared-assets pre-commit
          #
          # Everything outside this block is repo-specific and will be kept.
          # ------------------------------------------------------------------
          python3 - << 'PY'
          import sys
          from pathlib import Path

          repo_cfg = Path(".pre-commit-config.yaml")
          shared_cfg = Path("../shared-assets/ansible-collection/base/pre-commit-config.shared.yaml")

          base_begin = "# >>> BEGIN shared-assets pre-commit"
          base_end = "# <<< END shared-assets pre-commit"

          if not shared_cfg.is_file():
              print("WARN: shared pre-commit template not found, skipping shared block sync.")
              sys.exit(0)

          raw_block = shared_cfg.read_text().strip("\n")

          # Drop leading doc start + top-level repos: if present
          lines = raw_block.splitlines()
          if lines and lines[0].strip() == "---":
              lines = lines[1:]
          if lines and lines[0].strip() == "repos:":
              lines = lines[1:]
              # Drop one level of indentation from the shared block
              lines = [ln[2:] if ln.startswith("  ") else ln for ln in lines]

          # Drop any markers from the shared template (if present) to avoid duplicates
          lines = [ln for ln in lines if ln.strip() not in (base_begin, base_end)]
          shared_block = "\n".join(lines).strip("\n")

          # Load existing config (if any)
          text = repo_cfg.read_text() if repo_cfg.is_file() else ""

          # Ensure doc start and top-level repos key exist
          if not text.lstrip().startswith("---"):
              text = "---\n" + text.lstrip()
          lines_existing = text.splitlines()
          if not any(line.lstrip().startswith("repos:") for line in lines_existing):
              lines_existing.append("repos:")
              text = "\n".join(lines_existing) + "\n"

          # Strip any existing shared block regardless of indentation/newlines
          cleaned = []
          skipping = False
          for line in text.splitlines():
              if line.strip() == base_begin:
                  skipping = True
                  continue
              if line.strip() == base_end:
                  skipping = False
                  continue
              if not skipping:
                  cleaned.append(line)
          text = "\n".join(cleaned).strip("\n") + "\n"

          # Build normalized shared block (two-space indent under repos)
          target_begin = f"  {base_begin}"
          target_end = f"  {base_end}"

          # IMPORTANT: keep blank lines truly blank (no spaces) to avoid yaml[trailing-spaces]
          indented_lines = []
          for ln in shared_block.splitlines():
              if ln.strip():
                  indented_lines.append(f"  {ln.rstrip()}")
              else:
                  indented_lines.append("")
          indented_block = "\n".join(indented_lines).rstrip("\n")

          normalized_block = "\n".join([target_begin, indented_block, target_end]).rstrip("\n") + "\n"

          # Insert block immediately after the first repos: line
          out_lines = []
          inserted = False
          for line in text.splitlines():
              out_lines.append(line.rstrip())
              if not inserted and line.lstrip().startswith("repos:"):
                  out_lines.append(normalized_block.rstrip("\n"))
                  inserted = True

          if not inserted:
              out_lines.append("repos:")
              out_lines.append(normalized_block.rstrip("\n"))

          new_text = "\n".join(out_lines).rstrip() + "\n"

          # Final normalization:
          # - remove trailing whitespace on every line
          # - force markers to be exactly 2-space indented
          final = []
          for ln in new_text.splitlines():
              s = ln.strip()
              if s == base_begin:
                  final.append(f"  {base_begin}")
              elif s == base_end:
                  final.append(f"  {base_end}")
              else:
                  final.append(ln.rstrip())

          new_text = "\n".join(final).rstrip() + "\n"
          repo_cfg.write_text(new_text)
          PY

          # ------------------------------------------------------------------
          # Devtools scripts (wunder-devtools-ee wrapper, lint/molecule helpers)
          #
          # We want:
          #   - shared helpers synced exactly (including deletion of old ones)
          #   - BUT heavy Molecule scripts (devtools-molecule-*-heavy.sh)
          #     to remain repo-local and not be touched.
          # ------------------------------------------------------------------
          if [ -d "${SRC_AC}/scripts" ]; then
            echo "Syncing devtools scripts from ansible-collection/base (with --delete, excluding devtools-molecule-*-heavy.sh)..."
            mkdir -p ./scripts
            rsync -av \
              --delete \
              --exclude='devtools-molecule-*-heavy.sh' \
              "${SRC_AC}/scripts/" ./scripts/
          fi

          # Ensure wunder-devtools-ee.sh from default/scripts is present
          if [ -f "${SRC_DEFAULT}/scripts/wunder-devtools-ee.sh" ]; then
            echo "Syncing default/scripts/wunder-devtools-ee.sh into repo/scripts/..."
            mkdir -p ./scripts
            cp -f "${SRC_DEFAULT}/scripts/wunder-devtools-ee.sh" ./scripts/
          fi

          # ------------------------------------------------------------------
          # CI workflows for collections (Collection CI, Galaxy publish, etc.)
          # ------------------------------------------------------------------
          if [ -d "${SRC_AC}/.github/workflows" ]; then
            echo "Syncing CI workflows from ansible-collection/base (with --delete)..."
            mkdir -p .github/workflows
            rsync -av --delete "${SRC_AC}/.github/workflows/" .github/workflows/
          fi

          # Additional shared workflows (e.g., release) live outside base/.
          EXTRA_WF="../shared-assets/ansible-collection/.github/workflows"
          if [ -d "${EXTRA_WF}" ]; then
            echo "Syncing additional CI workflows from ansible-collection/.github/workflows..."
            mkdir -p .github/workflows
            rsync -av "${EXTRA_WF}/" .github/workflows/
          fi

      # --------------------------------------------------------------------
      # 4) Detect changes
      # --------------------------------------------------------------------
      - name: Detect changes
        id: diff
        working-directory: repo
        run: |
          if git status --porcelain | grep .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------------------------
      # 5) Avoid duplicate Authorization headers (some actions set extraheader)
      # --------------------------------------------------------------------
      - name: Remove duplicate GitHub auth header
        if: steps.diff.outputs.changed == 'true'
        working-directory: repo
        run: |
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --local --unset-all http.https://github.com/.extraheader || true

      # --------------------------------------------------------------------
      # 6) Create or update PR in target repo (one per sync branch)
      # --------------------------------------------------------------------
      - name: Create pull request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.SYNC_BOT_TOKEN }}
          path: repo
          commit-message: >-
            chore: sync shared assets from lightning-it/shared-assets
          branch: >-
            chore/sync-shared-assets-${{ matrix.repo }}
          title: "chore: sync shared assets"
          body: |
            Automated sync from
            [lightning-it/shared-assets](https://github.com/lightning-it/shared-assets).

            This PR updates:
            - Ansible collection tooling (ansible.cfg, .ansible-lint, pre-commit)
            - default policies (CODE_OF_CONDUCT.md, CONTRIBUTING.md)
            - shared devtools scripts (wunder-devtools-ee helpers)
            - collection CI workflows

            Please review and merge to keep this collection aligned with the
            central templates.
          labels: "chore,shared-assets"
          delete-branch: false
