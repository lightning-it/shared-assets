# yamllint disable rule:truthy rule:line-length
---
name: Sync shared assets into Ansible collections

on:
  # Auto-sync when shared assets change
  push:
    branches: ["main"]
    paths:
      - "default/**"
      - "ansible-collection/**"
      - ".github/workflows/sync-ansible-collections.yml"
  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  sync-collections:
    name: Sync shared assets â†’ ${{ matrix.repo }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        repo:
          - ansible-collection-foundational
          - ansible-collection-rhel
          - ansible-collection-supplementary
          - ansible-collection-ocp

    steps:
      # --------------------------------------------------------------------
      # 1) Checkout shared-assets (this repo)
      # --------------------------------------------------------------------
      - name: Checkout shared-assets
        uses: actions/checkout@v4
        with:
          path: shared-assets

      # --------------------------------------------------------------------
      # 2) Checkout target collection repo with bot token
      # --------------------------------------------------------------------
      - name: Checkout target collection repo
        uses: actions/checkout@v4
        with:
          repository: lightning-it/${{ matrix.repo }}
          path: repo
          token: ${{ secrets.SYNC_BOT_TOKEN }}
          fetch-depth: 0

      - name: Configure git author in target repo
        working-directory: repo
        run: |
          git config user.name "litreleasebot"
          git config user.email "litreleasebot@users.noreply.github.com"

      # --------------------------------------------------------------------
      # 3) Sync Ansible-collection-specific assets
      #    (.ansible-lint, ansible.cfg, shared pre-commit block, devtools, CI)
      # --------------------------------------------------------------------
      - name: Sync Ansible collection assets
        working-directory: repo
        run: |
          set -e

          SRC_AC="../shared-assets/ansible-collection"

          # ------------------------------------------------------------------
          # Copy all shared top-level files if present
          # ------------------------------------------------------------------
          for f in \
            ".ansible-lint" \
            "ansible.cfg" \
            "renovate.json" \
            "AGENT.md" \
            "CODE_OF_CONDUCT.md" \
            "CONTRIBUTING.md" \
            "SECURITY.md" \
            ".releaserc" \
            ".gitignore"
          do
            if [ -f "${SRC_AC}/${f}" ]; then
              echo "Syncing ${f} from shared-assets..."
              cp -f "${SRC_AC}/${f}" "./${f}"
            fi
          done

          # ------------------------------------------------------------------
          # Shared pre-commit block:
          # Replace content between the markers in .pre-commit-config.yaml:
          #   # >>> BEGIN shared-assets pre-commit
          #   ...
          #   # <<< END shared-assets pre-commit
          #
          # Everything outside this block is repo-specific and will be kept.
          # ------------------------------------------------------------------
          python3 - << 'PY'
          import sys
          from pathlib import Path

          repo_cfg = Path(".pre-commit-config.yaml")
          shared_cfg = Path("../shared-assets/ansible-collection/pre-commit.shared.yaml")

          begin = "# >>> BEGIN shared-assets pre-commit"
          end = "# <<< END shared-assets pre-commit"

          if not shared_cfg.is_file():
              print("WARN: shared pre-commit template not found, skipping shared block sync.")
              sys.exit(0)

          shared_block = shared_cfg.read_text().rstrip()

          if repo_cfg.is_file():
              text = repo_cfg.read_text()
          else:
              # Minimal skeleton if the file does not yet exist
              text = "repos:\n"

          if begin not in text or end not in text:
              print("WARN: Markers for shared pre-commit block not found; creating them at end of file.")
              # Append new block at the end, keeping any existing content intact
              new = text.rstrip() + "\n" + begin + "\n" + shared_block + "\n" + end + "\n"
              repo_cfg.write_text(new)
          else:
              start = text.index(begin)
              stop = text.index(end) + len(end)
              replacement = begin + "\n" + shared_block + "\n" + end
              new = text[:start] + replacement + text[stop:]
              repo_cfg.write_text(new)
          PY

          # Devtools scripts (wunder-devtools-ee wrapper, lint/molecule helpers)
          if [ -d "${SRC_AC}/scripts" ]; then
            echo "Syncing devtools scripts..."
            mkdir -p ./scripts
            rsync -av --delete "${SRC_AC}/scripts/" ./scripts/
          fi

          # CI workflows for collections (Collection CI, Galaxy publish, etc.)
          if [ -d "${SRC_AC}/.github/workflows" ]; then
            echo "Syncing CI workflows..."
            mkdir -p .github/workflows
            rsync -av --delete "${SRC_AC}/.github/workflows/" .github/workflows/
          fi

      # --------------------------------------------------------------------
      # 4) Detect changes
      # --------------------------------------------------------------------
      - name: Detect changes
        id: diff
        working-directory: repo
        run: |
          if git status --porcelain | grep .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------------------------
      # 5) Create or update PR in target repo (one per sync branch)
      # --------------------------------------------------------------------
      - name: Create pull request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.SYNC_BOT_TOKEN }}
          path: repo
          commit-message: >-
            chore: sync shared assets from lightning-it/shared-assets
          branch: >-
            chore/sync-shared-assets-${{ matrix.repo }}
          title: "chore: sync shared assets"
          body: |
            Automated sync from
            [lightning-it/shared-assets](https://github.com/lightning-it/shared-assets).

            This PR updates:
            - Ansible collection tooling (ansible.cfg, .ansible-lint, pre-commit)
            - shared devtools scripts (wunder-devtools-ee helpers)
            - collection CI workflows

            Please review and merge to keep this collection aligned with the
            central templates.
          labels: "chore,shared-assets"
          delete-branch: false
